---
/**
 * ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
 * ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€é€²æ—è¡¨ç¤ºã€ãƒ¬ãƒƒã‚¹ãƒ³ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰
 * Requirements: 3.1
 */

import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../components/Layout.astro';
import LessonCard from '../components/LessonCard.astro';
import ProgressBar from '../components/ProgressBar.astro';
import type { LessonCategory } from '../types/lesson';

// ãƒ¬ãƒƒã‚¹ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const lessonsEntries = await getCollection('lessons');

// ãƒ¬ãƒƒã‚¹ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
interface LessonData {
  id: string;
  category: LessonCategory;
  title: string;
  description: string;
}

const lessons: LessonData[] = lessonsEntries.map((entry: CollectionEntry<'lessons'>) => ({
  id: entry.data.id,
  category: entry.data.category as LessonCategory,
  title: entry.data.title,
  description: entry.data.description,
}));

// ãƒ¬ãƒƒã‚¹ãƒ³ã‚’IDã§ãƒãƒƒãƒ—åŒ–ï¼ˆã‚¢ã‚¤ã‚³ãƒ³å–å¾—ç”¨ï¼‰
const lessonIcons: Record<string, string> = {
  'web-intro': '\u{1F310}',
  'modern-web': '\u{1F680}',
  'html-intro': '\u{1F4D6}',
  'html-basics': '\u{1F4C4}',
  'css-intro': '\u{1F4D6}',
  'css-basics': '\u{1F3A8}',
  'js-intro': '\u{1F4D6}',
  'js-basics': '\u{26A1}',
  'js-advanced': '\u{1F525}',
  'ts-intro': '\u{1F4D6}',
  'ts-basics': '\u{1F4D8}',
  'git-intro': '\u{1F527}',
  'github-basics': '\u{1F419}',
  'deploy-guide': '\u{1F680}',
  'nodejs-intro': '\u{1F49A}',
  'npm-basics': '\u{1F4E6}',
  'eslint-prettier': '\u{2728}',
  'react-intro': '\u{269B}\u{FE0F}',
  'react-jsx': '\u{1F4DD}',
  'react-components': '\u{1F9E9}',
  'react-state': '\u{1F504}',
  'react-events': '\u{1F5B1}\u{FE0F}',
  'react-hooks': '\u{1FA9D}',
  'react-effects': '\u{26A1}',
  'react-patterns': '\u{1F3D7}\u{FE0F}',
  'tailwind-basics': '\u{1F30A}',
};

// ã‚»ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©
interface Section {
  title: string;
  ids: string[];
}

const sections: Section[] = [
  {
    title: '\u{1F4DA} ã¾ãšã¯ã“ã“ã‹ã‚‰',
    ids: ['web-intro', 'modern-web'],
  },
  {
    title: '\u{1F524} åŸºç¤ã‚’å­¦ã¶',
    ids: ['html-intro', 'html-basics', 'css-intro', 'css-basics', 'js-intro', 'js-basics', 'js-advanced'],
  },
  {
    title: '\u{1F537} TypeScript',
    ids: ['ts-intro', 'ts-basics'],
  },
  {
    title: '\u{1F6E0}\u{FE0F} ãƒ„ãƒ¼ãƒ«',
    ids: ['nodejs-intro', 'npm-basics', 'eslint-prettier', 'git-intro', 'github-basics', 'deploy-guide'],
  },
  {
    title: '\u{269B}\u{FE0F} React',
    ids: ['react-intro', 'react-jsx', 'react-components', 'react-state', 'react-events', 'react-hooks', 'react-effects', 'react-patterns'],
  },
  {
    title: '\u{1F3A8} Tailwind CSS',
    ids: ['tailwind-basics'],
  }
];

// ãƒ¬ãƒƒã‚¹ãƒ³ã‚’IDã§ãƒãƒƒãƒ—åŒ–
const lessonMap = new Map<string, LessonData>(lessons.map((l) => [l.id, l]));

// ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’äº‹å‰ã«è¨ˆç®—
const sectionsWithLessons = sections.map((section) => ({
  title: section.title,
  lessons: section.ids
    .map((id) => lessonMap.get(id))
    .filter((l): l is LessonData => l !== undefined),
}));

const totalLessons = lessons.length;
const basePath = import.meta.env.BASE_URL || '/teach-site/';
---

<Layout
  title="Web Dev Learn - Webé–‹ç™ºå­¦ç¿’ã‚µã‚¤ãƒˆ"
  description="Webé–‹ç™ºã®åŸºç¤ã‹ã‚‰æœ€æ–°æŠ€è¡“ã¾ã§ã€ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã§å­¦ã¹ã‚‹ç„¡æ–™å­¦ç¿’ã‚µã‚¤ãƒˆã€‚HTML, CSS, JavaScript, React, Tailwind CSSã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¨æ¼”ç¿’ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚"
>
  <div class="hero">
    <div class="hero-content">
      <h1 class="hero-title">WebæŠ€è¡“ã‚’<br />ã‚¹ãƒ”ãƒ¼ãƒ‡ã‚£ã«ç¿’å¾—</h1>
      <p class="hero-subtitle">HTMLã€CSSã€JavaScriptã®åŸºç¤ã‹ã‚‰Reactã€Tailwind CSSã¾ã§ã€‚ãƒ¢ãƒ€ãƒ³ãªWebé–‹ç™ºã®ã™ã¹ã¦ã‚’ã€ã“ã“ã§æ‰‹ã«å…¥ã‚Œã‚ˆã†ã€‚</p>
    </div>
    <div class="hero-image">
      <img src={`${basePath}banner.png`} alt="Web Development" />
    </div>
  </div>

  <div id="progress-container">
    <ProgressBar 
      title="å­¦ç¿’é€²æ—" 
      completedCount={0} 
      totalCount={totalLessons}
      showStats={true}
    />
  </div>

  <div id="continue-banner" class="continue-banner" style="display: none;">
    <div class="continue-text">
      <div class="continue-title">ğŸ“– ç¶šãã‹ã‚‰å­¦ç¿’</div>
      <div class="continue-subtitle" id="continue-lesson-title"></div>
    </div>
    <a href="#" class="continue-button" id="continue-link">
      ç¶šã‘ã‚‹ â†’
    </a>
  </div>

  {sectionsWithLessons.map((section) => (
    section.lessons.length > 0 && (
      <section class="lesson-section">
        <h2 class="home-section-title">{section.title}</h2>
        <div class="cards-grid">
          {section.lessons.map((lesson) => (
            <LessonCard
              id={lesson.id}
              icon={lessonIcons[lesson.id] || '\u{1F4C4}'}
              title={lesson.title}
              description={lesson.description}
              category={lesson.category}
            />
          ))}
        </div>
      </section>
    )
  ))}
</Layout>

<script>
  import { getCompletedCount, getProgressPercentage, getLastVisited, isLessonComplete } from '../scripts/progress';

  const lessonTitles: Record<string, string> = {
    'web-intro': 'Webé–‹ç™ºå…¥é–€',
    'modern-web': 'ãƒ¢ãƒ€ãƒ³Webé–‹ç™º',
    'html-intro': 'HTMLã¨ã¯',
    'html-basics': 'HTMLæ§‹æ–‡',
    'css-intro': 'CSSã¨ã¯',
    'css-basics': 'CSSæ§‹æ–‡',
    'js-intro': 'JavaScriptã¨ã¯',
    'js-basics': 'JavaScriptæ§‹æ–‡',
    'js-advanced': 'JavaScriptå¿œç”¨',
    'ts-intro': 'TypeScriptã¨ã¯',
    'ts-basics': 'TypeScriptåŸºç¤',
    'nodejs-intro': 'Node.jså…¥é–€',
    'npm-basics': 'npmåŸºç¤',
    'eslint-prettier': 'ESLint & Prettier',
    'git-intro': 'Gitå…¥é–€',
    'github-basics': 'GitHubã®åŸºæœ¬',
    'deploy-guide': 'ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰',
    'react-intro': 'Reactå…¥é–€',
    'react-jsx': 'JSXæ§‹æ–‡',
    'react-components': 'Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ',
    'react-state': 'Reactã®çŠ¶æ…‹ç®¡ç†',
    'react-events': 'Reactã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†',
    'react-hooks': 'React Hooks',
    'react-effects': 'React Effects',
    'react-patterns': 'Reactãƒ‘ã‚¿ãƒ¼ãƒ³',
    'tailwind-basics': 'Tailwind CSS',
  };

  function updateProgressDisplay() {
    const totalLessons = 26;
    const completedCount = getCompletedCount();
    const percentage = getProgressPercentage(totalLessons);

    const progressBar = document.querySelector('.progress-bar') as HTMLElement;
    const progressStats = document.querySelector('.progress-stats');
    const progressPercentage = document.querySelector('.progress-percentage');

    if (progressBar) {
      progressBar.style.width = `${percentage}%`;
      progressBar.dataset.percentage = String(percentage);
    }
    if (progressStats) {
      progressStats.textContent = `${completedCount} / ${totalLessons} ãƒ¬ãƒƒã‚¹ãƒ³å®Œäº†`;
    }
    if (progressPercentage) {
      progressPercentage.textContent = `${percentage}%`;
    }

    const lastVisited = getLastVisited();
    const continueBanner = document.getElementById('continue-banner');
    const continueTitle = document.getElementById('continue-lesson-title');
    const continueLink = document.getElementById('continue-link') as HTMLAnchorElement;

    if (lastVisited && !isLessonComplete(lastVisited) && continueBanner && continueTitle && continueLink) {
      const title = lessonTitles[lastVisited] || lastVisited;
      continueTitle.textContent = title;
      const basePath = '/teach-site/';
      continueLink.href = `${basePath}lessons/${lastVisited}/`;
      continueBanner.style.display = 'flex';
    }
  }

  document.addEventListener('DOMContentLoaded', updateProgressDisplay);
  window.addEventListener('pageshow', updateProgressDisplay);
</script>

<style>
  .hero {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-xl);
    align-items: center;
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-xl);
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
  }

  .hero-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .hero-title {
    font-size: 2.5rem;
    font-weight: 800;
    line-height: 1.2;
    color: var(--text-primary);
    margin: 0;
  }

  .hero-subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    line-height: 1.6;
    margin: 0;
  }

  .hero-image img {
    width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-md);
  }

  .continue-banner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-lg);
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark, #4f46e5));
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-xl);
    color: white;
  }

  .continue-text {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
  }

  .continue-title {
    font-size: 0.875rem;
    opacity: 0.9;
  }

  .continue-subtitle {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .continue-button {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-sm);
    color: white;
    text-decoration: none;
    font-weight: 500;
    transition: all var(--transition-base);
  }

  .continue-button:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .lesson-section {
    margin-bottom: var(--spacing-xl);
  }

  .home-section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--spacing-md);
    padding-bottom: var(--spacing-sm);
    border-bottom: 1px solid var(--border-color);
  }

  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--spacing-md);
  }

  #progress-container {
    margin-bottom: var(--spacing-xl);
  }

  @media (max-width: 768px) {
    .hero {
      grid-template-columns: 1fr;
      text-align: center;
    }

    .hero-title {
      font-size: 1.75rem;
    }

    .hero-image {
      order: -1;
    }

    .continue-banner {
      flex-direction: column;
      gap: var(--spacing-md);
      text-align: center;
    }

    .cards-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
