---
/**
 * Quizã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 * ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®island
 * Requirements: 6.1, 6.5
 */

import type { Exercise } from '../types/lesson';

interface Props {
  /** æ¼”ç¿’å•é¡Œã®é…åˆ— */
  exercises: Exercise[];
  /** ãƒ¬ãƒƒã‚¹ãƒ³ID */
  lessonId: string;
}

const { exercises, lessonId } = Astro.props;
---

{exercises.length > 0 && (
  <section class="quiz-section" data-lesson-id={lessonId}>
    <div class="quiz-header">
      <span class="quiz-icon">ğŸ“</span>
      <h2 class="quiz-title">æ¼”ç¿’å•é¡Œ</h2>
    </div>
    
    {exercises.map((exercise, index) => (
      <div class="quiz-item" data-quiz-index={index}>
        <p class="quiz-question">
          Q{index + 1}. {exercise.question}
        </p>
        <div class="quiz-options">
          {exercise.options.map((option, optionIndex) => (
            <button
              type="button"
              class="quiz-option"
              data-option-index={optionIndex}
              data-correct-answer={exercise.answer}
              data-explanation={exercise.explanation}
            >
              {option}
            </button>
          ))}
        </div>
        <div class="quiz-feedback" data-feedback-index={index}>
          <p class="feedback-text"></p>
        </div>
      </div>
    ))}
  </section>
)}

<script>
  import { checkAnswer, type QuizResult } from '../scripts/quiz';

  /**
   * ã‚¯ã‚¤ã‚ºã®åˆæœŸåŒ–
   * å„é¸æŠè‚¢ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
   */
  function initQuiz(): void {
    const quizItems = document.querySelectorAll('.quiz-item');
    
    quizItems.forEach((item) => {
      const options = item.querySelectorAll('.quiz-option');
      const feedbackEl = item.querySelector('.quiz-feedback') as HTMLElement | null;
      const feedbackText = feedbackEl?.querySelector('.feedback-text') as HTMLElement | null;
      
      options.forEach((option) => {
        option.addEventListener('click', () => {
          // æ—¢ã«å›ç­”æ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
          if (item.querySelector('.quiz-option.correct, .quiz-option.wrong')) {
            return;
          }
          
          const selectedIndex = parseInt(option.getAttribute('data-option-index') || '0', 10);
          const correctAnswer = parseInt(option.getAttribute('data-correct-answer') || '0', 10);
          const explanation = option.getAttribute('data-explanation') || '';
          
          // å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯
          const result: QuizResult = checkAnswer(selectedIndex, correctAnswer);
          
          // é¸æŠã—ãŸé¸æŠè‚¢ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
          option.classList.add(result.isCorrect ? 'correct' : 'wrong');
          
          // æ­£è§£ã®é¸æŠè‚¢ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆä¸æ­£è§£ã®å ´åˆï¼‰
          if (!result.isCorrect) {
            options.forEach((opt) => {
              const optIndex = parseInt(opt.getAttribute('data-option-index') || '0', 10);
              if (optIndex === correctAnswer) {
                opt.classList.add('correct');
              }
            });
          }
          
          // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
          if (feedbackEl && feedbackText) {
            feedbackEl.classList.add('show', result.isCorrect ? 'correct' : 'wrong');
            feedbackText.textContent = result.isCorrect 
              ? `âœ… æ­£è§£ï¼ ${explanation}`
              : `âŒ ä¸æ­£è§£... ${explanation}`;
          }
          
          // ä»–ã®é¸æŠè‚¢ã‚’ç„¡åŠ¹åŒ–
          options.forEach((opt) => {
            (opt as HTMLButtonElement).disabled = true;
          });
        });
      });
    });
  }

  // DOMContentLoadedã§åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', initQuiz);
  
  // Astroã®ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã«ã‚‚åˆæœŸåŒ–
  document.addEventListener('astro:page-load', initQuiz);
</script>
